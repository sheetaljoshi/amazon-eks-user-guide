include::../attributes.txt[]

[.topic]
[#integration-secrets-manager]
= Manage application secrets with {aws} Secrets Manager
:info_titleabbrev: {aws} Secrets Manager

[abstract]
--
{aws} Secrets Manager helps you manage, access, and rotate credentials, API keys, and other secrets throughout their lifecycle.
--

link:secrets-manager/[{aws} Secrets Manager,type="marketing"] helps you manage, access, and rotate credentials, API keys, and other secrets throughout their lifecycle.
With Secrets Manager, you can secure and manage secrets used to access resources in {aws}, on third-party services, and on-premises.
For more information, see the link:secretsmanager/latest/userguide/intro.html[{aws} Secrets Manager User Guide,type="documentation"].

When using the EKS Capability for Argo CD, Secrets Manager provides a secure way to store and retrieve Git repository credentials without hardcoding sensitive data in your Argo CD configuration and resources.
This integration is particularly useful for managing private repository access tokens and SSH keys used by Argo CD to sync applications from Git repositories.

[#integration-secrets-manager-use]
== Use {aws} Secrets Manager with Argo CD

When using the EKS Capability for Argo CD, you can store Git repository credentials in Secrets Manager and configure Argo CD to retrieve them.
This approach is more secure than storing credentials directly in Argo CD configuration or using long-lived personal access tokens.

*Prerequisites*

* An Amazon EKS cluster with the Argo CD capability enabled
* Git repository credentials stored in {aws} Secrets Manager
* IAM permissions configured for Argo CD to access Secrets Manager

*To configure Argo CD to use Secrets Manager for repository credentials*

. Store your Git credentials in Secrets Manager. For example, to store a GitHub personal access token:
+
[source,bash]
----
aws secretsmanager create-secret \
  --name argocd/github-token \
  --secret-string '{"username":"git","password":"ghp_xxxxxxxxxxxx"}'
----

. Ensure the Argo CD capability role has permissions to retrieve the secret:
+
[source,json,subs="verbatim,attributes"]
----
{
  "Version": "2012-10-17",{tcx5-waiver}
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ],
      "Resource": "arn:aws:secretsmanager:region:account-id:secret:argocd/github-token*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "kms:Decrypt"
      ],
      "Resource": "arn:aws:kms:region:account-id:key/*",
      "Condition": {
        "StringLike": {
          "kms:EncryptionContext:SecretARN": "arn:aws:secretsmanager:region:account-id:secret:argocd/*",
          "kms:ViaService": "secretsmanager.*.amazonaws.com"
        }
      }
    }
  ]
}
----
+
[NOTE]
====
The KMS decrypt permission is required because Secrets Manager encrypts all secrets using {aws} KMS.
The condition restricts decryption to only secrets with the `argocd/` prefix.
If you use the default {aws} managed key for Secrets Manager, this permission is sufficient.
For customer managed KMS keys, update the `Resource` field with your specific key ARN.
====

. Configure Argo CD to use the credentials from Secrets Manager. For information about syncing secrets from Secrets Manager into Kubernetes secrets that Argo CD can reference, see link:https://argo-cd.readthedocs.io/en/stable/operator-manual/secret-management/[Secret Management^] in the Argo CD documentation.

. Create an Argo CD repository configuration that references the secret ARN:
+
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: private-repo
  namespace: argocd
  labels:
    argocd.argoproj.io/secret-type: repository
stringData:
  type: git
  url: https://github.com/org/repo
  secretArn: arn:aws:secretsmanager:region:account-id:secret:argocd/github-token
----

For more information about configuring repository access with Argo CD, see <<argocd-configure-repositories>>.
