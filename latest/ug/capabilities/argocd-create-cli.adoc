include::../attributes.txt[]

[.topic]
[#argocd-create-cli]
= Create an Argo CD capability using the {aws} CLI
:info_titleabbrev: {aws} CLI

This topic describes how to create an Argo CD capability using the {aws} CLI.

== Prerequisites

* *{aws} CLI* – Version `{auto-cli-v2-version}` or later. To check your version, run `aws --version`. For more information, see link:cli/latest/userguide/cli-chap-install.html[Installing, updating, and uninstalling the {aws} CLI,type="documentation"] in the {aws} Command Line Interface User Guide.
* *`kubectl`* – A command line tool for working with Kubernetes clusters. For more information, see <<install-kubectl>>.
* *{aws} Identity Center configured* – Argo CD requires {aws} Identity Center for authentication. Local users are not supported. If you don't have {aws} Identity Center set up, see link:singlesignon/latest/userguide/getting-started.html[Getting started with {aws} Identity Center,type="documentation"] to create an Identity Center instance, and link:singlesignon/latest/userguide/addusers.html[Add users,type="documentation"] and link:singlesignon/latest/userguide/addgroups.html[Add groups,type="documentation"] to create users and groups for Argo CD access.

== Step 1: Create an IAM Capability Role

Create a trust policy file:

[source,bash,subs="verbatim,attributes"]
----
cat > argocd-trust-policy.json << 'EOF'
{
  "Version": "2012-10-17",{tcx5-waiver}
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "capabilities.eks.amazonaws.com"
      },
      "Action": [
        "sts:AssumeRole",
        "sts:TagSession"
      ]
    }
  ]
}
EOF
----

Create the IAM role:

[source,bash,subs="verbatim,attributes"]
----
aws iam create-role \
  --role-name ArgoCDCapabilityRole \
  --assume-role-policy-document file://argocd-trust-policy.json
----

[NOTE]
====
If you plan to use the optional integrations with {aws} Secrets Manager or {aws} CodeConnections, you'll need to add permissions to the role.
For IAM policy examples and configuration guidance, see <<integration-secrets-manager>> and <<integration-codeconnections>>.
====

== Step 2: Create the Argo CD capability

Create the Argo CD capability resource on your cluster.

First, set environment variables for your Identity Center configuration:

[source,bash,subs="verbatim,attributes"]
----
# Get your Identity Center instance ARN (replace region if your IDC instance is in a different region)
export IDC_INSTANCE_ARN=$(aws sso-admin list-instances --region [.replaceable]`region` --query 'Instances[0].InstanceArn' --output text)

# Get a user ID for RBAC mapping (replace with your username and region if needed)
export IDC_USER_ID=$(aws identitystore list-users \
  --region [.replaceable]`region` \
  --identity-store-id $(aws sso-admin list-instances --region [.replaceable]`region` --query 'Instances[0].IdentityStoreId' --output text) \
  --query 'Users[?UserName==`your-username`].UserId' --output text)

echo "IDC_INSTANCE_ARN=$IDC_INSTANCE_ARN"
echo "IDC_USER_ID=$IDC_USER_ID"
----

Create the capability with Identity Center integration. Replace [.replaceable]`region-code` with the {aws} Region where your cluster is located and [.replaceable]`my-cluster` with your cluster name:

[source,bash,subs="verbatim,attributes,quotes"]
----
aws eks create-capability \
  --region [.replaceable]`region-code` \
  --cluster-name [.replaceable]`my-cluster` \
  --capability-name my-argocd \
  --type ARGOCD \
  --role-arn arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):role/ArgoCDCapabilityRole \
  --delete-propagation-policy RETAIN \
  --configuration '{
    "argoCd": {
      "awsIdc": {
        "idcInstanceArn": "'$IDC_INSTANCE_ARN'",
        "idcRegion": "'[.replaceable]`region-code`'"
      },
      "rbacRoleMappings": [{
        "role": "ADMIN",
        "identities": [{
          "id": "'$IDC_USER_ID'",
          "type": "SSO_USER"
        }]
      }]
    }
  }'
----

The command returns immediately, but the capability takes some time to become active as EKS creates the required capability infrastructure and components.
EKS will install the Kubernetes Custom Resource Definitions related to this capability in your cluster as it is being created.

[NOTE]
====
If you receive an error that the cluster doesn't exist or you don't have permissions, verify:

* The cluster name is correct
* Your {aws} CLI is configured for the correct region
* You have the required IAM permissions


====

== Step 3: Verify the capability is active

Wait for the capability to become active. Replace [.replaceable]`region-code` with the {aws} Region where your cluster is located and [.replaceable]`my-cluster` with your cluster name.

[source,bash,subs="verbatim,attributes,quotes"]
----
aws eks describe-capability \
  --region [.replaceable]`region-code` \
  --cluster-name [.replaceable]`my-cluster` \
  --capability-name my-argocd \
  --query 'capability.status' \
  --output text
----

The capability is ready when the status shows `ACTIVE`.
Don't continue to the next step until the status is `ACTIVE`.

You can also view the full capability details:

[source,bash,subs="verbatim,attributes,quotes"]
----
aws eks describe-capability \
  --region [.replaceable]`region-code` \
  --cluster-name [.replaceable]`my-cluster` \
  --capability-name my-argocd
----

== Step 4: Verify custom resources are available

After the capability is active, verify that Argo CD custom resources are available in your cluster:

[source,bash,subs="verbatim,attributes"]
----
kubectl api-resources | grep argoproj.io
----

You should see `Application` and `ApplicationSet` resource types listed.

== Next steps

* <<working-with-argocd>> - Configure repositories, register clusters, and create Applications

* <<argocd-considerations>> - Multi-cluster architecture and advanced configuration
* <<working-with-capabilities>> - Manage your Argo CD capability resource
